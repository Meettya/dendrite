!function(e,r){"function"==typeof define&&define.amd?define([],r):e.Dendrite=r()}(this,function(){function e(e,r){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(r)}}))}function r(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},i=function(){function e(e,r){var t=[],i=!0,n=!1,s=void 0;try{for(var o,u=e[Symbol.iterator]();!(i=(o=u.next()).done)&&(t.push(o.value),!r||t.length!==r);i=!0);}catch(a){n=!0,s=a}finally{try{!i&&u["return"]&&u["return"]()}finally{if(n)throw s}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),n=function(){function e(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(r,t,i){return t&&e(r.prototype,t),i&&e(r,i),r}}(),s=e(["Undefined publisher engine type |","|"],["Undefined publisher engine type |","|"]),o=3,u=2,a=1,c=0,l=Symbol("internal subscribe bus"),h=Symbol("internal unsubscribe bus"),b=function(){function e(t){r(this,e),this.observerVerboseLevel=this.parseVerboseLevel(t),this.publishingCounter=0,this.subscriptions=new Map,this.tasksDictionary=new WeakMap,this.unsubscribeQueue=[]}return n(e,[{key:"subscribe",value:function(e,r,t){return this.subscribeGuarded(e,r,void 0,t)}},{key:"subscribeGuarded",value:function(e,r,t,i){if("string"!=typeof e&&!this.isInternalChannel(e)||"function"!=typeof r||t&&"function"!=typeof t)throw this.subscribeErrorMessage(e,r,t,i);var n={},s=this.topicsToArraySplitter(e);this.tasksDictionary.set(n,[r,i,t]);var o=!0,u=!1,a=void 0;try{for(var c,h=s[Symbol.iterator]();!(o=(c=h.next()).done);o=!0){var b=c.value,f=[];this.subscriptions.has(b)&&(f=this.subscriptions.get(b)),f.push(n),this.subscriptions.set(b,f),this.isInternalChannel(b)||this.publishAsync(l,b)}}catch(y){u=!0,a=y}finally{try{!o&&h.return&&h.return()}finally{if(u)throw a}}return{topics:e,callback:r,watchdog:t,context:i}}},{key:"unsubscribe",value:function(e,r,t){var n=void 0;if(e.topics){var s=this.handlerParser(e,r,t),o=i(s,3);e=o[0],r=o[1],t=o[2]}if("string"!=typeof e&&!this.isInternalChannel(e))throw this.unsubscribeErrorMessage(e,r,t);if(this.isPublishing())return this.unsubscribeQueue.push([e,r,t]),this;n=this.topicsToArraySplitter(e);var u=!0,a=!1,c=void 0;try{for(var l,b=n[Symbol.iterator]();!(u=(l=b.next()).done);u=!0){var f=l.value;if(this.subscriptions.has(f)){if("function"==typeof r){var y=this.subscriptions.get(f),p=!0,v=!1,g=void 0;try{for(var d,k=y.entries()[Symbol.iterator]();!(p=(d=k.next()).done);p=!0){var w=i(d.value,2),m=w[0],E=w[1],S=this.tasksDictionary.get(E);if(S){var C=i(S,2),T=C[0],L=C[1];Object.is(T,r)&&(t?Object.is(L,t)&&y.splice(m,1):y.splice(m,1))}}}catch(A){v=!0,g=A}finally{try{!p&&k.return&&k.return()}finally{if(v)throw g}}this.subscriptions.set(f,y)}else this.subscriptions.delete(f);this.isInternalChannel(f)||this.publishAsync(h,f)}}}catch(A){a=!0,c=A}finally{try{!u&&b.return&&b.return()}finally{if(a)throw c}}return this}},{key:"publish",value:function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),i=1;r>i;i++)t[i-1]=arguments[i];return this.publisher("sync",e,t),this}},{key:"publishSync",value:function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),i=1;r>i;i++)t[i-1]=arguments[i];return this.publisher("sync",e,t),this}},{key:"publishAsync",value:function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),i=1;r>i;i++)t[i-1]=arguments[i];return this.publisher("async",e,t),this}},{key:"getListenedTopicsList",value:function(){var e=[],r=!0,t=!1,n=void 0;try{for(var s,o=this.subscriptions.entries()[Symbol.iterator]();!(r=(s=o.next()).done);r=!0){var u=i(s.value,2),a=u[0],c=u[1];c.length&&!this.isInternalChannel(a)&&e.push(a)}}catch(l){t=!0,n=l}finally{try{!r&&o.return&&o.return()}finally{if(t)throw n}}return e}},{key:"isTopicListened",value:function(e){if("string"!=typeof e||""===e)throw this.isTopicListenedErrorMessage(e,"isTopicListened","topic");return!!this.getSubscribtionsCount(e)}},{key:"on",value:function(e,r){var t=void 0;if("string"!=typeof e||""===e)throw this.isTopicListenedErrorMessage(e,"on","activity type");if("function"!=typeof r)throw TypeError("callback is not function");if(t=e.toLowerCase(),"subscribe"===t)return this.subscribe(l,function(e,t){r(t)});if("unsubscribe"===t)return this.subscribe(h,function(e,t){r(t)});throw Error("unknown activity type |"+e+"|")}},{key:"off",value:function(e){if(e&&"object"===("undefined"==typeof e?"undefined":t(e))&&e.topics){var r=void 0,n=void 0,s=this.handlerParser(e),o=i(s,3);e=o[0],r=o[1],n=o[2],this.unsubscribe(e,r,n)}else{var u=void 0,a=void 0;if("string"!=typeof e||""===e)throw this.isTopicListenedErrorMessage(e,"off","activity type");if(u=e.toLowerCase(),"subscribe"===u)a=l;else{if("unsubscribe"!==u)throw Error("unknown activity type |"+e+"|");a=h}this.unsubscribe(a)}}},{key:"isInternalChannel",value:function(e){return e===l||e===h}},{key:"handlerParser",value:function(e,r,t){var i=e.topics;return r||(r=e.callback),t||(t=e.context),[i,r,t]}},{key:"isPublishing",value:function(){return!!this.publishingCounter}},{key:"getPublisherEngine",value:function(e){var r=void 0,t=void 0,i=this;if(r={sync:{publish:i.publishFiring,unsubscribe:i.unsubscribeResume},async:{publish:function(e,r,t){setImmediate(function(){i.publishFiring(e,r,t)})},unsubscribe:function(){setImmediate(function(){i.unsubscribeResume()})}}},t=r[e],!t)throw TypeError(s,e);return[t.publish,t.unsubscribe]}},{key:"publisher",value:function(e,r,t){var n=void 0,s=this.getPublisherEngine(e),o=i(s,2),u=o[0],a=o[1];if("string"!=typeof r&&!this.isInternalChannel(r))throw this.publishErrorMessage(r,t);n=this.topicsToArraySplitter(r,!1);var c=!0,l=!1,h=void 0;try{for(var b,f=n[Symbol.iterator]();!(c=(b=f.next()).done);c=!0){var y=b.value;if(this.subscriptions.has(y)){var p=!0,v=!1,g=void 0;try{for(var d,k=this.subscriptions.get(y)[Symbol.iterator]();!(p=(d=k.next()).done);p=!0){var w=d.value,m=this.tasksDictionary.get(w);m&&(this.publishingInc(),u.call(this,y,m,t))}}catch(E){v=!0,g=E}finally{try{!p&&k.return&&k.return()}finally{if(v)throw g}}}}}catch(E){l=!0,h=E}finally{try{!c&&f.return&&f.return()}finally{if(l)throw h}}a.call(this)}},{key:"publishingInc",value:function(){this.publishingCounter=this.publishingCounter+1}},{key:"publishingDec",value:function(){if(!this.publishingCounter)throw Error('Error on decrement publishing counter - this.publishingCounter is |' + this.publishingCounter + '|');this.publishingCounter=this.publishingCounter-1}},{key:"topicsToArraySplitter",value:function(e){var r=arguments.length<=1||void 0===arguments[1]?!0:arguments[1],t=void 0,i=[],n={};if(this.isInternalChannel(e))return[e];t=e.split(" ");var s=!0,o=!1,u=void 0;try{for(var a,c=t[Symbol.iterator]();!(s=(a=c.next()).done);s=!0){var l=a.value;""===l||r&&n[l]||(n[l]=!0,i.push(l))}}catch(h){o=!0,u=h}finally{try{!s&&c.return&&c.return()}finally{if(o)throw u}}return i}},{key:"getVerboseLevel",value:function(){return this.observerVerboseLevel}},{key:"getSubscribtionsCount",value:function(e){var r=this.subscriptions.get(e);return r?r.length:void 0}},{key:"unsubscribeResume",value:function(){var e=void 0;if(this.unsubscribeQueue.length){if(this.isPublishing())return void(this.observerVerboseLevel>=o&&console.log("still publishing"));do e=this.unsubscribeQueue.shift(),e&&(this.observerVerboseLevel>=o&&console.log("retry unsubscribe |"+e+"|"),this.unsubscribe.apply(this,e));while(e)}}},{key:"publishFiring",value:function(e,r,t){try{r[0].apply(r[1]||{},[e].concat(t))}catch(i){r[2]&&r[2].call(r[1]||{},i,{topic:e,callback:r[0],object:r[1],data:t}),this.observerVerboseLevel>=a&&console.error("Error: on call subscribe callback we got exception\n          topic     = |"+e+"|\n          callback  = |"+r[0]+"|\n          watchdog  = |"+r[2]+"|\n          object    = |"+(JSON.stringify(r[1])||r[1])+"|\n          data      = |"+t+"|\n          error     = |"+i+"|\n        "),this.observerVerboseLevel===o&&i.stack&&console.error(i.stack)}finally{this.publishingDec()}}},{key:"parseVerboseLevel",value:function(e){if(e&&"object"===("undefined"==typeof e?"undefined":t(e))){var r=e.verbose;if(r){if("string"!=typeof r)throw TypeError("Error on parsing verbose level - not a String |"+r+"|");switch(r.toUpperCase()){case"DEBUG":return o;case"SILENT":return c;case"ERROR":return a;case"WARNING":return u;default:throw Error("Unknown verbose level |"+r+"|")}}}return a}},{key:"subscribeErrorMessage",value:function(e,r,t,i){var n="Error! on call |subscribe| used non-string topics OR/AND callback isn`t function OR/AND watchdog defined but isn`t function:\n      topics    = |"+e+"|\n      callback  = |"+r+"|\n      watchdog  = |"+t+"|\n      context   = |"+i+"|";return TypeError(n)}},{key:"publishErrorMessage",value:function(e,r){var t="Error on call |publish| used non-string topics:\n      topics    = |"+e+"|\n      data      = |"+r+"|";return TypeError(t)}},{key:"unsubscribeErrorMessage",value:function(e,r,t){var i="Error on call |unsubscribe| used non-string topics:\n      topics    = |"+e+"|\n      callback  = |"+r+"|\n      context   = |"+t+"|";return TypeError(i)}},{key:"isTopicListenedErrorMessage",value:function(e,r,t){var i="Error on call |"+r+"| used non-string, or empty string as "+t+":\n      "+t+"  = |"+e+"|";return TypeError(i)}}]),e}();return b});